{% extends 'base.html' %}

{% block title %}Ver Facturas{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Facturas</h2>
    <a href="{{ url_for('crear_factura') }}" class="btn btn-success mb-3 rounded-pill">Crear Nueva Factura</a>
    {% if facturas %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Número de Factura</th>
                    <th>Fecha de Emisión</th>
                    <th>Cliente</th>
                    <th>Descripción</th>
                    <th>Monto Total</th>
                    <th>Fecha de Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for factura in facturas %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ factura.numero_factura }}</td>
                    <td>{{ factura.fecha_emision.strftime('%Y-%m-%d') }}</td>
                    <td>{{ factura.cliente.nombre | title }} {{ factura.cliente.primer_apellido | title or '' }}</td>
                    <td>{{ factura.descripcion | default('', True) | truncate(50) }}</td>
                    <td>₡{{ factura.monto_total }}</td>
                    <td>{{ factura.fecha_registro.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <a href="{{ url_for('editar_factura', id=factura.id) }}" class="btn btn-sm btn-primary rounded-pill">Editar</a>
                        <button type="button" class="btn btn-sm btn-danger rounded-pill borrar-factura-btn-swal"
                                data-factura-id="{{ factura.id }}"
                                data-factura-numero="{{ factura.numero_factura }}"
                                data-factura-cliente="{{ factura.cliente.nombre | title }} {{ factura.cliente.primer_apellido | title or '' }}">
                            Borrar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hay facturas registradas.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const botonesBorrar = document.querySelectorAll('.borrar-factura-btn-swal');

        botonesBorrar.forEach(boton => {
            boton.addEventListener('click', function() {
                const facturaId = this.dataset.facturaId;
                const facturaNumero = this.dataset.facturaNumero;
                const clienteNombreCompleto = this.dataset.facturaCliente;

                Swal.fire({
                    title: `¿Estás seguro de borrar a ${clienteNombreCompleto}?`,
                    text: `¿Deseas borrar la factura número ${facturaNumero}?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, borrar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/borrar_factura/${facturaId}`;

                        const csrfTokenInput = document.createElement('input');
                        csrfTokenInput.type = 'hidden';
                        csrfTokenInput.name = 'csrf_token';
                        csrfTokenInput.value = "{{ csrf_token }}";

                        form.appendChild(csrfTokenInput);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    });
</script>
{% endblock %}