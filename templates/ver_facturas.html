{% extends 'base.html' %}

{% block title %}Ver Facturas{% endblock %} {# Mantén tu título si lo usas #}

{% block content %}
<div class="container mt-4"> {# Ajustado de mt-5 a mt-4 para consistencia con ejemplos anteriores #}
    <h1 class="mb-4">Lista de Facturas</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('crear_factura') }}" class="btn btn-success mb-3 rounded-pill">Crear Nueva Factura</a> {# Usando btn-success como en tu versión #}
        {# Si tienes un botón para exportar o reportes, podría ir aquí #}
    </div>

    {% if facturas %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle"> {# Manteniendo table-hover y align-middle #}
            <thead class="table-dark"> {# Manteniendo table-dark #}
                <tr>
                    <th>#</th> {# Mantén el loop.index si lo necesitas #}
                    <th># Factura</th>
                    <th>Cliente</th>
                    <th>Fecha Emisión</th>
                    <th>Monto Total</th>
                    {# --- NUEVAS COLUMNAS INTEGRADO AQUÍ --- #}
                    <th>Interés</th>
                    <th>Realizado Por</th>
                    <th>Tipo Actividad</th>
                    <th>Nombre Actividad/Etapa</th>
                    <th>Costo Actividad</th>
                    {# ------------------------------------ #}
                    <th>Descripción</th> {# Mantenemos Descripción y Fecha de Registro #}
                    <th>Fecha de Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for factura in facturas %}
                <tr>
                    <td>{{ loop.index }}</td> {# Usando loop.index #}
                    <td>{{ factura.numero_factura }}</td>
                    <td>
                        {% if factura.cliente %}
                            {{ factura.cliente.nombre.title() }}
                            {{ factura.cliente.primer_apellido.title() if factura.cliente.primer_apellido else '' }}
                            {{ factura.cliente.segundo_apellido.title() if factura.cliente.segundo_apellido else '' }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ factura.fecha_emision.strftime('%Y-%m-%d') }}</td>
                    <td>₡{{ "%.2f"|format(factura.monto_total) }}</td> {# Asegurando formato numérico #}
                    {# --- MOSTRAR NUEVOS DATOS INTEGRADO AQUÍ --- #}
                    <td>{{ factura.interes if factura.interes else 'N/A' }}</td>
                    <td>{{ factura.realizado_por if factura.realizado_por else 'N/A' }}</td>
                    <td>{{ factura.tipo_actividad if factura.tipo_actividad else 'N/A' }}</td>
                    <td>{{ factura.nombre_actividad_etapa if factura.nombre_actividad_etapa else 'N/A' }}</td>
                    <td>₡{{ "%.2f"|format(factura.costo_actividad) if factura.costo_actividad is not none else 'N/A' }}</td> {# Manejo de None #}
                    {# ------------------------------------------ #}
                    <td>{{ factura.descripcion | default('', True) | truncate(50) }}</td> {# Truncate y default #}
                    <td>{{ factura.fecha_registro.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <a href="{{ url_for('editar_factura', id=factura.id) }}" class="btn btn-sm btn-primary rounded-pill">Editar</a> {# btn-primary como en tu versión #}
                        <button type="button" class="btn btn-sm btn-danger rounded-pill borrar-factura-btn-swal"
                                data-factura-id="{{ factura.id }}"
                                data-factura-numero="{{ factura.numero_factura }}"
                                data-factura-cliente="{{ factura.cliente.nombre | title }} {{ factura.cliente.primer_apellido | title or '' }} {{ factura.cliente.segundo_apellido | title or '' }}"> {# Agregado segundo apellido aquí #}
                            Borrar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center">No hay facturas registradas.</p> {# Centrado para mejor visualización #}
    {% endif %}
</div>

{# --- SweetAlert2 Script --- #}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const botonesBorrar = document.querySelectorAll('.borrar-factura-btn-swal');

        botonesBorrar.forEach(boton => {
            boton.addEventListener('click', function() {
                const facturaId = this.dataset.facturaId;
                const facturaNumero = this.dataset.facturaNumero;
                const clienteNombreCompleto = this.dataset.facturaCliente;

                Swal.fire({
                    title: `¿Estás seguro?`,
                    text: `¿Deseas borrar la factura número ${facturaNumero} del cliente ${clienteNombreCompleto}? Esta acción es irreversible.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, borrar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/borrar_factura/${facturaId}`;

                        const csrfTokenInput = document.createElement('input');
                        csrfTokenInput.type = 'hidden';
                        csrfTokenInput.name = 'csrf_token';
                        // LA LÍNEA CRÍTICA: Cambiada de 'csrf_token()' a 'generate_csrf()'
                        csrfTokenInput.value = "{{ generate_csrf() }}"; 

                        form.appendChild(csrfTokenInput);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    });
</script>
{% endblock %}
