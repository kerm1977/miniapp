{% extends 'base.html' %}

{% block title %}Ver Facturas{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Lista de Facturas</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{{ url_for('crear_factura') }}" class="btn btn-success mb-3 rounded-pill">Crear Nueva Factura</a>
    </div>

    {% if facturas %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Número de Factura</th>
                    <th>Cliente</th>
                    <th>Monto Total</th>
                    <th>Fecha de Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for factura in facturas %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ factura.numero_factura }}</td>
                    <td>
                        {% if factura.cliente %}
                            {{ factura.cliente.nombre.title() }}
                            {{ factura.cliente.primer_apellido.title() if factura.cliente.primer_apellido else '' }}
                            {{ factura.cliente.segundo_apellido.title() if factura.cliente.segundo_apellido else '' }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>₡{{ "%.2f"|format(factura.monto_total) }}</td>
                    <td>{{ factura.fecha_registro.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        {# --- NUEVO BOTÓN "VER" AQUÍ --- #}
                        <a href="{{ url_for('ver_detalle_factura', id=factura.id) }}" class="btn btn-sm btn-info me-2 rounded-pill">Ver</a>
                        {# ----------------------------- #}
                        <a href="{{ url_for('editar_factura', id=factura.id) }}" class="btn btn-sm btn-primary me-2 rounded-pill">Editar</a> {# Añadí me-2 para espacio #}
                        <button type="button" class="btn btn-sm btn-danger rounded-pill borrar-factura-btn-swal"
                                data-factura-id="{{ factura.id }}"
                                data-factura-numero="{{ factura.numero_factura }}"
                                data-factura-cliente="{{ factura.cliente.nombre | title }} {{ factura.cliente.primer_apellido | title or '' }} {{ factura.cliente.segundo_apellido | title or '' }}">
                            Borrar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center">No hay facturas registradas.</p>
    {% endif %}
</div>

{# --- SweetAlert2 Script (Mantén este script como está) --- #}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const botonesBorrar = document.querySelectorAll('.borrar-factura-btn-swal');

        botonesBorrar.forEach(boton => {
            boton.addEventListener('click', function() {
                const facturaId = this.dataset.facturaId;
                const facturaNumero = this.dataset.facturaNumero;
                const clienteNombreCompleto = this.dataset.facturaCliente;

                Swal.fire({
                    title: `¿Estás seguro?`,
                    text: `¿Deseas borrar la factura número ${facturaNumero} del cliente ${clienteNombreCompleto}? Esta acción es irreversible.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, borrar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/borrar_factura/${facturaId}`;

                        const csrfTokenInput = document.createElement('input');
                        csrfTokenInput.type = 'hidden';
                        csrfTokenInput.name = 'csrf_token';
                        csrfTokenInput.value = "{{ generate_csrf() }}";

                        form.appendChild(csrfTokenInput);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    });
</script>
{% endblock %}